using Game.Core.FSM;
using Game.Utils;
using Godot;

namespace Game.Logic.AI.Aimer.FSM
{
    [Tool]
    public partial class IdleState : State
    {
        #region PRIVATE FIELDS
        private Character _character;
        #endregion

        #region EDITOR FIELDS
        [Export]
        public Timer IdleTimer;
        #endregion

        #region SIGNAL METHODS
        [SignalMethod]
        public void _OnIdleTimerTimeout()
        {
            _character.NavAgent.RequestPathTo(CustomNavigationServer.Instance.GetRandomPointInActiveRegion());
            _character.CanAttack = true;
            FSM.RequestState<WalkState>();
        }
        #endregion

        #region FSM STATE METHODS
        [StateMethod]
        public override void _StateReady()
        {
            base._StateReady();

            _character = Root<Character>();
        }

        [StateMethod]
        public override void _StateEnter()
        {
            base._StateEnter();

            _character.AnimationTree.RequestAnimation("Transition", "Idle")
                .UpdateBlendPosition("Idle", _character.MoveComponent.Direction);

            _character.MoveComponent.Velocity = Vector2.Zero;

            IdleTimer.Start();
        }

        [StateMethod]
        public override void _StateExit()
        {
            base._StateExit();

            IdleTimer.Stop();
        }
        #endregion
    }
}
using Game.Core.FSM;
using Game.Utils;
using Godot;

namespace Game.Logic.AI.Tank.FSM
{
    [Tool]
    public partial class AvoidWalkState : State
    {
        #region SIGNAL METHODS
        [SignalMethod]
        public void _OnHealthComponentApplyHeal(Node from, float value)
        {
            if (!FSM.IsCurrentStateEqual<AvoidWalkState>())
                return;

            _hit++;

            if (_hit == 1)
            {
                _character.NavAgent.SetTarget(_character.NavigationRegion.GetRandomPointRadius(_character.GlobalPosition,
                    _character.AvoidWalkToHitRadius.X,
                    _character.AvoidWalkToHitRadius.Y));
                FSM.RequestState<AvoidWalkHitState>();
                _hit = 0;
            }
        }
        #endregion

        #region FSM STATE METHODS
        [StateMethod]
        public override void _StateReady()
        {
            base._StateReady();

            _character = Root<Character>();
        }

        [StateMethod]
        public override void _StateEnter()
        {
            base._StateEnter();

            _character.AnimationTree.RequestAnimation("Transition", "Walk")
                .UpdateBlendPosition("Walk", _character.MoveComponent.Direction);
        }

        [StateMethod]
        public override void _StateProcess(double delta)
        {
            base._StateProcess(delta);

            _character.AnimationTree.UpdateBlendPosition("Walk", _character.MoveComponent.Direction);
        }

        [StateMethod]
        public override void _StateProcessPhysics(double delta)
        {
            base._StateProcessPhysics(delta);

            if (_character.NavAgent.IsTargetReached)
            {
                _hit = 0;
                FSM.RequestState<AvoidIdleState>();

                return;
            }

            _character.MoveComponent.Move(_character.AvoidWalkSpeed);
        }
        #endregion

        #region PRIVATE FIELDS
        private Character _character;
        private int _hit = 0;
        #endregion
    }
}